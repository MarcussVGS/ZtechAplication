<!DOCTYPE html>
<html lang="pt-BR"  xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Início - Dashboard ZTech</title>
    <link rel="stylesheet" th:href="@{/styles/reset.css}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/styles/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px; 
            padding: 20px;
        }
        .dashboard-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: .25rem;
            padding: 20px;
            flex-grow: 1; 
            min-width: 280px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            display: flex; 
            flex-direction: column; 
        }
        .dashboard-card h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.5rem;
            color: #333;
        }
        .dashboard-card p.metric-value { 
            font-size: 2rem;
            font-weight: bold;
            color: #7C1F1F; 
            margin-bottom: 5px;
        }
        .dashboard-card .details {
            font-size: 0.9rem;
            color: #555;
            margin-top: auto; 
        }
        
        .status-card-container {
            width: calc(100% - 0px); 
            margin-top: 20px;
            margin-bottom:20px;
        }
        .status-counts-wrapper {
            display: flex;
            gap: 15px; 
            flex-wrap: wrap; 
            justify-content: space-around; 
        }
        .status-card {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px 20px;
            text-align: center;
            min-width: 130px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-basis: calc(20% - 15px); 
            max-width: 150px;
        }
        .status-card .status-name {
            font-size: 0.9rem;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
            white-space: nowrap; 
        }
        .status-card .status-count {
            font-size: 1.7rem;
            font-weight: bold;
            color: #7C1F1F;
        }

        .financial-cards-container, .charts-container { /* Container para cards financeiros e gráficos */
            display: flex;
            flex-wrap: wrap;
            gap: 20px; 
            padding: 0px 20px 20px 20px; 
        }
        .charts-container .dashboard-card { /* Gráficos ocupam metade da largura */
             flex-basis: calc(50% - 30px); /* (100% / 2) - (gap / 2 ajustado para o gap de 20px) */
             max-width: calc(50% - 30px); /* Ajustado */
        }
        canvas { /* Para garantir que o canvas seja responsivo dentro do card */
            max-width: 100%;
            max-height: 300px; /* Altura máxima para os gráficos */
        }
    </style>
</head>
<body>
    <header class="cabecalho">
        <a th:href="@{/inicio}"> 
            <img class="logo_cabecalho" th:src="@{/img/logo-removebg.svg}" alt="Logo ZTech"/>
        </a> 
        <div class="titulo_pagina">Dashboard ZTech</div>
    </header>
    <div class="area-principal">
        <div class="barra">
            <ul>
				<li class="opcao_lista"><a class="link_lista_atual" th:href="@{/inicio}">INÍCIO</a></li>
                <li class="opcao_lista"><a class="link_lista" th:href="@{/cliente/listar}" >CLIENTES</a></li>
                <li class="opcao_lista"><a class="link_lista" th:href="@{/produto/listar}">ESTOQUE</a></li>
                <li class="opcao_lista"><a class="link_lista" th:href="@{/vendas/listar}">VENDAS</a></li>
                <li class="opcao_lista"><a class="link_lista" th:href="@{/ordens/listar}">ORDENS DE SERVIÇO</a></li>
            </ul>
	    </div>
        
        <div class="conteudo" style="display: flex; flex-direction: column;"> 
            <h4>Visão Geral do Sistema</h4>

            <div class="dashboard-container">
                <div class="dashboard-card">
                    <h3>Total de Clientes</h3>
                    <p class="metric-value" th:text="${totalClientes}">0</p>
                    <a th:href="@{/cliente/listar}" class="details">Ver todos os clientes...</a>
                </div>

                <div class="dashboard-card">
                    <h3>Total de Produtos</h3> 
                    <p class="metric-value" th:text="${totalProdutos}">0</p>
                     <a th:href="@{/produto/listar}" class="details">Ver estoque...</a>
                </div>

                <div class="dashboard-card">
                    <h3>Total de Ordens de Serviço</h3>
                    <p class="metric-value" th:text="${totalOS}">0</p>
                    <a th:href="@{/ordens/listar}" class="details">Ver todas as O.S....</a>
                </div>
            </div>

            <div class="dashboard-card status-card-container"> 
                <h3>Ordens de Serviço por Status</h3>
                <div th:if="${contagemTotalPorStatus == null or contagemTotalPorStatus.isEmpty()}" style="padding-top:10px;">
                    <p class="details">Nenhuma Ordem de Serviço registrada.</p>
                </div>
                <div class="status-counts-wrapper" th:unless="${contagemTotalPorStatus == null or contagemTotalPorStatus.isEmpty()}">
                    <div th:each="statusEntry : ${contagemTotalPorStatus}" class="status-card">
                        <div class="status-name" th:text="${statusEntry.key}">Status</div>
                        <div class="status-count" th:text="${statusEntry.value}">0</div>
                    </div>
                </div>
            </div>
            
            <h4 style="padding-left: 20px; margin-top: 20px;">Métricas Financeiras (Ordens de Serviço)</h4>
            <div class="financial-cards-container">
                 <div class="dashboard-card">
                    <h3>Valor em Aberto (OS)</h3>
                    <p class="metric-value" th:text="${#numbers.formatCurrency(valorTotalOSAbertas)}">R$ 0,00</p>
                    <span class="details">Soma de OS "Registrada" e "Em Andamento"</span>
                </div>
                <div class="dashboard-card">
                    <h3>Lucro OS Concluídas (Mês Atual)</h3>
                    <p class="metric-value" th:text="${#numbers.formatCurrency(lucroTotalOSConcluidasMes)}">R$ 0,00</p>
                    <span class="details">Soma do lucro de OS "Concluído" neste mês</span>
                </div>
            </div>

            <h4 style="padding-left: 20px; margin-top: 20px;">Análises Gráficas (Ordens de Serviço)</h4>
            <div class="charts-container">
                <div class="dashboard-card"> <h3>Distribuição de OS por Status</h3>
                    <canvas id="graficoStatusOS"></canvas>
                    <div id="noDataGraficoStatusOS" style="display:none;"><p class="details">Nenhuma OS para exibir no gráfico de status.</p></div>
                </div>
            
                <div class="dashboard-card"> <h3>OS Criadas nos Últimos 7 Dias</h3>
                    <canvas id="graficoOsRecentes"></canvas>
                    <div id="noDataGraficoOsRecentes" style="display:none;"><p class="details">Nenhuma OS criada nos últimos 7 dias.</p></div>
                </div>
            </div>
            
        </div>
    </div>

<script th:inline="javascript">
/*<![CDATA[*/
    // --- GRÁFICO DE STATUS DE OS (DOUGHNUT) ---
    var labelsStatus = /*[[${labelsGraficoStatusOs}]]*/ null;
    var dadosStatus = /*[[${dadosGraficoStatusOs}]]*/ null;

    // Verifica se há dados e se a soma dos dados é maior que zero para desenhar o gráfico
    if (labelsStatus && dadosStatus && labelsStatus.length > 0 && dadosStatus.reduce((a, b) => a + b, 0) > 0) {
        document.getElementById('noDataGraficoStatusOS').style.display = 'none';
        document.getElementById('graficoStatusOS').style.display = 'block';
        const ctxStatusOS = document.getElementById('graficoStatusOS').getContext('2d');
        new Chart(ctxStatusOS, {
            type: 'doughnut', 
            data: {
                labels: labelsStatus,
                datasets: [{
                    label: 'Nº de OS',
                    data: dadosStatus,
                    backgroundColor: [ 
                        'rgba(54, 162, 235, 0.8)',  // Azul (Ex: Registrada)
                        'rgba(255, 206, 86, 0.8)', // Amarelo (Ex: Em Andamento)
                        'rgba(75, 192, 192, 0.8)',  // Verde (Ex: Concluido)
                        'rgba(255, 159, 64, 0.8)', // Laranja (Ex: Cliente Ausente)
                        'rgba(255, 99, 132, 0.8)'   // Vermelho (Ex: Cancelado)
                        // Adapte as cores à sua StatusLibrary e à ordem dos status
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, 
                plugins: {
                    legend: {
                        position: 'right', 
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    } else {
        document.getElementById('graficoStatusOS').style.display = 'none'; 
        document.getElementById('noDataGraficoStatusOS').style.display = 'block';
    }

    // --- GRÁFICO DE OS CRIADAS NOS ÚLTIMOS 7 DIAS (LINHA) ---
    var labelsRecentes = /*[[${labelsGraficoOsRecentes}]]*/ null;
    var dadosRecentes = /*[[${dadosGraficoOsRecentes}]]*/ null;

    // Verifica se há dados para desenhar o gráfico
    if (labelsRecentes && dadosRecentes && labelsRecentes.length > 0) {
        // Verifica se há pelo menos um valor maior que zero para exibir o gráfico
        let hasDataRecentes = dadosRecentes.some(dado => dado > 0);

        if (hasDataRecentes) {
            document.getElementById('noDataGraficoOsRecentes').style.display = 'none';
            document.getElementById('graficoOsRecentes').style.display = 'block';
            const ctxOsRecentes = document.getElementById('graficoOsRecentes').getContext('2d');
            new Chart(ctxOsRecentes, {
                type: 'line', 
                data: {
                    labels: labelsRecentes, // Formato dd/MM
                    datasets: [{
                        label: 'OS Criadas',
                        data: dadosRecentes,
                        borderColor: 'rgb(124, 31, 31)', 
                        backgroundColor: 'rgba(124, 31, 31, 0.2)', 
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1 
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false 
                        }
                    }
                }
            });
        } else {
             document.getElementById('graficoOsRecentes').style.display = 'none';
             document.getElementById('noDataGraficoOsRecentes').style.display = 'block';
        }
    } else {
        document.getElementById('graficoOsRecentes').style.display = 'none';
        document.getElementById('noDataGraficoOsRecentes').style.display = 'block';
    }
/*]]>*/
</script>
</body>
</html>